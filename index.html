<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Getreidebuchung</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:       #0f1108;
      --surface:  #1a1d0f;
      --border:   #2e3318;
      --gold:     #c8a84b;
      --gold-dim: #7a6530;
      --green:    #6abf69;
      --red:      #e05252;
      --text:     #e8e4d4;
      --muted:    #7a7860;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 20px 40px;
      gap: 32px;
    }

    /* Grain texture overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    header {
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
      z-index: 1;
    }

    .logo {
      font-family: 'DM Serif Display', serif;
      font-size: 1.5rem;
      color: var(--gold);
      letter-spacing: 0.02em;
    }

    .logo span {
      color: var(--muted);
      font-size: 0.85rem;
      font-family: 'DM Mono', monospace;
      font-weight: 400;
    }

    .card {
      width: 100%;
      max-width: 480px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
      z-index: 1;
    }

    .card-label {
      font-size: 0.65rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    /* â”€â”€ MIC BUTTON â”€â”€ */
    .mic-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    #micBtn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 2px solid var(--gold-dim);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }

    #micBtn:hover { border-color: var(--gold); }
    #micBtn:active { transform: scale(0.95); }

    #micBtn.recording {
      border-color: var(--red);
      box-shadow: 0 0 0 8px rgba(224,82,82,0.12), 0 0 0 20px rgba(224,82,82,0.05);
      animation: pulse 1.4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 8px rgba(224,82,82,0.12), 0 0 0 20px rgba(224,82,82,0.05); }
      50%       { box-shadow: 0 0 0 14px rgba(224,82,82,0.08), 0 0 0 28px rgba(224,82,82,0.03); }
    }

    .mic-icon {
      width: 44px;
      height: 44px;
      fill: none;
      stroke: var(--gold);
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: stroke 0.2s;
    }

    #micBtn.recording .mic-icon { stroke: var(--red); }

    .mic-status {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: center;
      min-height: 1.2em;
      letter-spacing: 0.04em;
    }

    #micBtn.recording ~ .mic-status { color: var(--red); }

    /* â”€â”€ TRANSCRIPT â”€â”€ */
    #transcript {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      font-family: 'DM Mono', monospace;
      font-size: 0.85rem;
      color: var(--text);
      resize: none;
      min-height: 80px;
      line-height: 1.6;
      outline: none;
      transition: border-color 0.2s;
    }

    #transcript:focus { border-color: var(--gold-dim); }
    #transcript::placeholder { color: var(--muted); }

    /* â”€â”€ SUBMIT BUTTON â”€â”€ */
    #submitBtn {
      width: 100%;
      padding: 15px;
      background: var(--gold);
      color: var(--bg);
      border: none;
      border-radius: 10px;
      font-family: 'DM Mono', monospace;
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.15s;
    }

    #submitBtn:hover { opacity: 0.88; }
    #submitBtn:active { transform: scale(0.98); }
    #submitBtn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* â”€â”€ RESULT CARD â”€â”€ */
    #result {
      width: 100%;
      max-width: 480px;
      display: none;
      flex-direction: column;
      gap: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      z-index: 1;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .result-header {
      padding: 14px 20px;
      font-size: 0.65rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-header.success { background: rgba(106,191,105,0.1); color: var(--green); }
    .result-header.error   { background: rgba(224,82,82,0.1);   color: var(--red);   }

    .result-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: currentColor;
    }

    .result-rows { display: flex; flex-direction: column; }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 11px 20px;
      border-top: 1px solid var(--border);
      gap: 16px;
    }

    .result-key   { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.06em; flex-shrink: 0; }
    .result-value { font-size: 0.85rem; color: var(--text); text-align: right; word-break: break-word; }
    .result-value.total { color: var(--gold); font-size: 1rem; }

    /* â”€â”€ LOADER â”€â”€ */
    .loader {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 4px 0;
    }

    .loader.active { display: flex; }

    .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--gold-dim);
      animation: bounce 1.2s ease-in-out infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40%            { transform: scale(1);   opacity: 1;   }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">Getreidehandel <span>// Scheiper</span></div>
</header>

<!-- INPUT CARD -->
<div class="card">
  <div class="card-label">Neuer Eintrag</div>

  <div class="mic-wrap">
    <button id="micBtn" title="Aufnahme starten">
      <svg class="mic-icon" viewBox="0 0 24 24">
        <rect x="9" y="2" width="6" height="11" rx="3"/>
        <path d="M5 10a7 7 0 0 0 14 0"/>
        <line x1="12" y1="17" x2="12" y2="21"/>
        <line x1="9"  y1="21" x2="15" y2="21"/>
      </svg>
    </button>
    <div class="mic-status" id="micStatus">Tippen zum Sprechen</div>
  </div>

  <div>
    <div class="card-label" style="margin-bottom:8px">Erkannter Text (bearbeitbar)</div>
    <textarea id="transcript" rows="3" placeholder="z.B. Â»25 Tonnen Weizen von Meyer gekauft, 210 EuroÂ«"></textarea>
  </div>

  <div class="loader" id="loader">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>

  <button id="submitBtn" disabled>Buchen â†’</button>
</div>

<!-- RESULT CARD -->
<div id="result"></div>

<script>
  // â”€â”€ KONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Hier deine Google Apps Script Web-App URL eintragen (nach Deployment):
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyyyEJGIAyXMgPk8mnRt2_SP2JqD3k__9F_qZmDuQIBNzzaerBsQCNMkBXfEHZWLDCj/exec";
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const micBtn    = document.getElementById("micBtn");
  const micStatus = document.getElementById("micStatus");
  const transcript= document.getElementById("transcript");
  const submitBtn = document.getElementById("submitBtn");
  const loader    = document.getElementById("loader");
  const resultDiv = document.getElementById("result");

  // â”€â”€ SPRACHEINGABE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let isRecording = false;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = "de-DE";
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = () => {
      isRecording = true;
      micBtn.classList.add("recording");
      micStatus.textContent = "Aufnahme lÃ¤uft â€¦";
    };

    recognition.onresult = (e) => {
      let interim = "", final = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        e.results[i].isFinal ? final += t : interim += t;
      }
      transcript.value = final || interim;
      submitBtn.disabled = !transcript.value.trim();
    };

    recognition.onend = () => {
      isRecording = false;
      micBtn.classList.remove("recording");
      micStatus.textContent = transcript.value.trim()
        ? "Aufnahme beendet â€“ Text bearbeiten oder direkt buchen"
        : "Tippen zum Sprechen";
    };

    recognition.onerror = (e) => {
      isRecording = false;
      micBtn.classList.remove("recording");
      micStatus.textContent = e.error === "not-allowed"
        ? "âš  Mikrofon-Zugriff verweigert"
        : "Fehler: " + e.error;
    };

    micBtn.addEventListener("click", () => {
      if (isRecording) { recognition.stop(); }
      else             { recognition.start(); }
    });
  } else {
    micBtn.disabled = true;
    micStatus.textContent = "Spracherkennung nicht unterstÃ¼tzt â€“ bitte Text eingeben";
  }

  // Manuelle Text-Eingabe aktiviert auch den Button
  transcript.addEventListener("input", () => {
    submitBtn.disabled = !transcript.value.trim();
  });

  // â”€â”€ BUCHUNG SENDEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  submitBtn.addEventListener("click", async () => {
    const text = transcript.value.trim();
    if (!text) return;

    submitBtn.disabled = true;
    loader.classList.add("active");
    resultDiv.style.display = "none";

    try {
   const res = await fetch(APPS_SCRIPT_URL, {
  method: "POST",
  body: JSON.stringify({ text }),
  headers: { "Content-Type": "text/plain" },
  redirect: "follow"
});
      const data = await res.json().catch(() => ({ success: false, error: "Antwort konnte nicht gelesen werden." }));

      if (data.success) {
        showResult(data);
        transcript.value = "";
        submitBtn.disabled = true;
        micStatus.textContent = "Tippen zum Sprechen";
      } else {
        showError(data.error || "Unbekannter Fehler");
      }
    } catch (err) {
      showError("Verbindungsfehler: " + err.message);
    } finally {
      loader.classList.remove("active");
      submitBtn.disabled = false;
    }
  });

  // â”€â”€ ERGEBNIS ANZEIGEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showResult(d) {
    const typ    = d.typ    === "Einkauf" ? "ðŸŸ¢ Einkauf" : "ðŸ”µ Verkauf";
    const gesamt = d.gesamt !== "???" ? `${Number(d.gesamt).toLocaleString("de-DE", {minimumFractionDigits:2})} â‚¬` : "???";

    resultDiv.innerHTML = `
      <div class="result-header success">
        <div class="result-dot"></div> Erfolgreich gebucht
      </div>
      <div class="result-rows">
        <div class="result-row"><span class="result-key">Typ</span>     <span class="result-value">${typ}</span></div>
        <div class="result-row"><span class="result-key">Partner</span> <span class="result-value">${d.partner}</span></div>
        <div class="result-row"><span class="result-key">Sorte</span>   <span class="result-value">${d.sorte}</span></div>
        <div class="result-row"><span class="result-key">Menge</span>   <span class="result-value">${d.menge} t</span></div>
        <div class="result-row"><span class="result-key">Preis</span>   <span class="result-value">${d.preis} â‚¬/t</span></div>
        <div class="result-row"><span class="result-key">Gesamt</span>  <span class="result-value total">${gesamt}</span></div>
      </div>`;
    resultDiv.style.display = "flex";
    resultDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
  }

  function showError(msg) {
    resultDiv.innerHTML = `
      <div class="result-header error">
        <div class="result-dot"></div> Fehler
      </div>
      <div class="result-rows">
        <div class="result-row"><span class="result-value">${msg}</span></div>
      </div>`;
    resultDiv.style.display = "flex";
  }
</script>
</body>
</html>
